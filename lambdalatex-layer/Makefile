default: help

# Always run these rules.
#.PHONY: build package localtest localtest-quick clean


# Display make information when no commands are given.
help:
	@echo "Usage: make [options] target"
	@echo ""
	@echo "Targets"
	@echo "    download       Download external dependencies."
	@echo "    build          Build the Docker image with the lambdalatex-layer files."
	@echo "    package        Create the AWS Lambda Layer zip archive."
	@echo "    deploy         Deploy the packaged layer via Serverless."
	@echo "    remove         Remove the deployed layer via Serverless."
	@echo "    test           Test (locally) the packaged layers to ensure they work."
	@echo "    clean          Remove all files generated by this makefile."
	@echo ""
	@echo "Options"
	@echo "    -B           Force rule to always execute."


download:
	$(MAKE) -C vendor

# Build the Docker image with perl and texlive installed into /opt for packaging.
build: download
	docker build --force-rm -t lambdalatex-layer:latest .

# Package /opt into a zip archive for AWS Lambda to use as a runtime Layer.
# This zip file should always be built and needs to be deleted first because I'm
# not sure how to delete non-existant files in a previously created zip archive.
package:
	rm -f lambdalatex-layer.zip
	docker run --rm -it -v ${PWD}:/var/host lambdalatex-layer:latest bash -c "cd /opt; zip -qry -9 /var/host/lambdalatex-layer.zip ."

deploy:
	sls deploy --verbose

remove:
	sls remove --verbose

# Test the built image/package.
test:
	@echo "Target 'test' for lambdalatex-layer not implemented."

# Remove all built artifacts.
clean:
	$(MAKE) -C vendor clean
	rm -f lambdalatex-layer.zip
	docker image prune -f
